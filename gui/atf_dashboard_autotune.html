<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATF Dashboard - AutoTune</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .slider::-moz-range-thumb { width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================================
// ICONS
// ============================================================
const Icons = {
  Play: () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.8A1.5 1.5 0 004 4.1v11.8a1.5 1.5 0 002.3 1.3l9.1-5.9a1.5 1.5 0 000-2.6L6.3 2.8z"/></svg>,
  Pause: () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 00-1 1v10a1 1 0 001 1h2a1 1 0 001-1V5a1 1 0 00-1-1H5zM13 4a1 1 0 00-1 1v10a1 1 0 001 1h2a1 1 0 001-1V5a1 1 0 00-1-1h-2z"/></svg>,
  Stop: () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4h12v12H4z"/></svg>,
  Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>,
  ChevronDown: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>,
  ChevronRight: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,
  Wifi: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/></svg>,
  WifiOff: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/></svg>,
  Brain: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>,
  Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
  Tune: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>,
  Trophy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>,
  Sparkles: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>,
  X: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
  Copy: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>,
  Zap: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
  Loader: () => <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>,
};

// ============================================================
// CONFIG & DATASETS
// ============================================================
const DEFAULT_CONFIG = {
  dataset: 'mnist', epochs: 10, batchSize: 128, learningRate: 0.001, mode: 'full', useRealTraining: false, seed: 42,
  maxSeqLength: 128, blockSize: 256,
  useEarlyStopping: true, caMaxLrReductions: 2, metaNoImprovePatience: 4,
  useConvergenceAnalysis: true, useGradientFeedback: true, usePeriodicLR: true, useConvergenceDamper: true,
  useTemporalBuffer: true, useHarmonicInit: true, useMetaController: true, useCurvatureRegularizer: false,
  caPatience: 5, caMinDelta: 0.005, caEmaAlpha: 0.3, caLrFactor: 0.5,
  gfAlpha: 0.08, gfOmega: 6.0, gfPhi: 0.3, gfEmaAlpha: 0.3, gfClamp: 0.2,
  lrOmega: 6.0, lrAmplitude: 0.08, lrDecay: 0.003, lrPhi: 1.0472, lrStepMode: 'epoch',
  cdThreshold: 0.008, cdAlphaDamp: 0.4, cdEpsilon: 0.01,
  tbSize: 10, harmonicOmega: 6.0, harmonicPhi: 0.0, harmonicAmpWeight: 0.01, harmonicAmpBias: 0.001,
  mcPatience: 5, mcLrFactor: 0.5, curvatureLambda: 0.01, curvatureThreshold: 0.1,
};

const DATASETS = {
  vision: [
    {value: 'mnist', label: 'MNIST', epochs: 10, classes: 10, type: 'vision'},
    {value: 'fashion_mnist', label: 'Fashion-MNIST', epochs: 15, classes: 10, type: 'vision'},
    {value: 'cifar10', label: 'CIFAR-10', epochs: 50, classes: 10, type: 'vision'},
    {value: 'cifar100', label: 'CIFAR-100', epochs: 75, classes: 100, type: 'vision'},
  ],
  nlp_bert: [
    {value: 'bert_sst2', label: 'BERT SST-2', epochs: 3, classes: 2, type: 'bert', task: 'sst2', metric: 'accuracy'},
    {value: 'bert_mrpc', label: 'BERT MRPC', epochs: 3, classes: 2, type: 'bert', task: 'mrpc', metric: 'f1'},
  ],
  nlp_gpt: [
    {value: 'nanogpt_shakespeare', label: 'NanoGPT Shakespeare', epochs: 20, type: 'nanogpt', task: 'shakespeare', metric: 'perplexity'},
  ],
};
const ALL_DATASETS = [...DATASETS.vision, ...DATASETS.nlp_bert, ...DATASETS.nlp_gpt];

// ============================================================
// AUTOTUNE SEARCH SPACES
// ============================================================
const SEARCH_SPACES = {
  quick: {
    name: 'Quick Tune',
    description: '5 runs, key parameters only',
    runs: 5,
    params: {
      lrOmega: [5.0, 6.0, 7.0],
      lrAmplitude: [0.04, 0.08, 0.12],
      gfAlpha: [0.04, 0.08],
    }
  },
  full: {
    name: 'Full Tune',
    description: '15 runs, comprehensive search',
    runs: 15,
    params: {
      lrOmega: [4.0, 5.0, 6.0, 7.0, 8.0],
      lrAmplitude: [0.02, 0.05, 0.08, 0.12],
      lrDecay: [0.001, 0.003, 0.005],
      gfAlpha: [0.03, 0.05, 0.08, 0.12],
      cdThreshold: [0.005, 0.008, 0.012],
      caPatience: [3, 5, 7],
    }
  },
  smart: {
    name: 'Smart Tune',
    description: 'AI-guided search with Claude analysis',
    runs: 8,
    params: {
      lrOmega: [4.0, 5.0, 6.0, 7.0, 8.0],
      lrAmplitude: [0.02, 0.05, 0.08, 0.12, 0.16],
      lrDecay: [0.0, 0.001, 0.003, 0.005],
      gfAlpha: [0.02, 0.05, 0.08, 0.12],
      gfOmega: [4.0, 6.0, 8.0],
      cdThreshold: [0.004, 0.008, 0.015],
    }
  }
};

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
const formatTime = (s) => { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}m ${sec.toString().padStart(2,'0')}s`; };

const generateRandomConfig = (baseConfig, space) => {
  const config = {...baseConfig};
  Object.entries(space.params).forEach(([key, values]) => {
    config[key] = values[Math.floor(Math.random() * values.length)];
  });
  return config;
};

const generateGridConfigs = (baseConfig, space, maxRuns) => {
  const configs = [];
  const keys = Object.keys(space.params);
  
  // Simple random sampling from grid
  for (let i = 0; i < maxRuns; i++) {
    const config = {...baseConfig};
    keys.forEach(key => {
      const values = space.params[key];
      config[key] = values[Math.floor(Math.random() * values.length)];
    });
    configs.push(config);
  }
  return configs;
};

// ============================================================
// UI COMPONENTS
// ============================================================
const Section = ({title, color, children, defaultOpen = true}) => {
  const [open, setOpen] = useState(defaultOpen);
  const colors = {green: 'border-green-600 text-green-400', blue: 'border-blue-600 text-blue-400', purple: 'border-purple-600 text-purple-400', yellow: 'border-yellow-600 text-yellow-400', orange: 'border-orange-600 text-orange-400'};
  return (
    <div className={`mb-2 border-l-2 ${colors[color]||'border-gray-600'} bg-slate-800/30 rounded-r`}>
      <button onClick={() => setOpen(!open)} className="w-full px-2 py-1.5 flex items-center justify-between text-left hover:bg-slate-700/30">
        <span className={`text-xs font-medium ${colors[color]?.split(' ')[1]||'text-gray-400'}`}>{title}</span>
        {open ? <Icons.ChevronDown/> : <Icons.ChevronRight/>}
      </button>
      {open && <div className="px-2 pb-2">{children}</div>}
    </div>
  );
};

const Slider = ({label, value, onChange, min, max, step, disabled}) => (
  <div className="mb-1.5">
    <div className="flex justify-between text-[10px] mb-0.5"><span className="text-gray-400">{label}</span><span className="text-blue-400 font-mono">{typeof value === 'number' ? (value < 0.01 ? value.toExponential(1) : value.toFixed(step < 1 ? Math.max(0, -Math.floor(Math.log10(step))) : 0)) : value}</span></div>
    <input type="range" min={min} max={max} step={step} value={value} onChange={e => onChange(parseFloat(e.target.value))} disabled={disabled} className="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer slider disabled:opacity-50"/>
  </div>
);

const Toggle = ({label, enabled, onChange, disabled, desc}) => (
  <div className="flex items-center justify-between py-1">
    <div><span className="text-[10px] text-gray-300">{label}</span>{desc && <span className="text-[9px] text-gray-500 ml-1">({desc})</span>}</div>
    <button onClick={() => !disabled && onChange(!enabled)} disabled={disabled} className={`w-8 h-4 rounded-full transition-colors ${enabled ? 'bg-blue-600' : 'bg-gray-600'} ${disabled ? 'opacity-50' : ''}`}>
      <div className={`w-3 h-3 rounded-full bg-white transition-transform ${enabled ? 'translate-x-4' : 'translate-x-0.5'}`}/>
    </button>
  </div>
);

const Select = ({label, value, onChange, options, disabled}) => (
  <div className="mb-1.5">
    <div className="text-[10px] text-gray-400 mb-0.5">{label}</div>
    <select value={value} onChange={e => onChange(e.target.value)} disabled={disabled} className="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-xs text-white disabled:opacity-50">
      {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
    </select>
  </div>
);

const MetricBox = ({label, value, unit, color, small}) => {
  const colors = {green: 'border-green-500', blue: 'border-blue-500', purple: 'border-purple-500', yellow: 'border-yellow-500', cyan: 'border-cyan-500', orange: 'border-orange-500', pink: 'border-pink-500', gray: 'border-gray-500', red: 'border-red-500'};
  return (
    <div className={`bg-gray-800/60 border-l-2 ${colors[color]||'border-gray-500'} rounded px-2 py-1`}>
      <div className="text-[9px] text-gray-500 uppercase">{label}</div>
      <div className={`font-mono font-bold ${small ? 'text-sm' : 'text-base'} text-white`}>{value}<span className="text-[10px] text-gray-400 ml-0.5">{unit}</span></div>
    </div>
  );
};

const Chart = ({data, dataKey, color, title, height = 60}) => {
  const maxVal = Math.max(...data.map(d => d[dataKey] || 0), 0.001);
  const minVal = Math.min(...data.map(d => d[dataKey] || 0), 0);
  const range = maxVal - minVal || 1;
  const points = data.slice(-100).map((d, i, arr) => {
    const x = (i / Math.max(arr.length - 1, 1)) * 100;
    const y = height - ((((d[dataKey] || 0) - minVal) / range) * (height - 10) + 5);
    return `${x},${y}`;
  }).join(' ');
  return (
    <div className="bg-gray-800/40 rounded p-1.5">
      <div className="text-[9px] text-gray-500 mb-1">{title}</div>
      <svg viewBox={`0 0 100 ${height}`} className="w-full" style={{height}}>
        {points && <polyline fill="none" stroke={color} strokeWidth="1.5" points={points}/>}
        <text x="2" y="10" fill="#9ca3af" fontSize="6">{maxVal.toFixed(2)}</text>
        <text x="2" y={height-2} fill="#9ca3af" fontSize="6">{minVal.toFixed(2)}</text>
      </svg>
    </div>
  );
};

// ============================================================
// LEADERBOARD COMPONENT
// ============================================================
const Leaderboard = ({runs, onSelect, onApply}) => {
  const sorted = [...runs].sort((a, b) => (b.accuracy || 0) - (a.accuracy || 0));
  const best = sorted[0];
  
  return (
    <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
      <div className="flex items-center gap-2 mb-3">
        <Icons.Trophy />
        <span className="font-bold text-yellow-400">Leaderboard</span>
        <span className="text-[10px] text-gray-500">({runs.length} runs)</span>
      </div>
      
      {best && (
        <div className="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-600/50 rounded-lg p-2 mb-3">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-[10px] text-yellow-400">üèÜ BEST RUN</div>
              <div className="text-xl font-bold text-white">{best.accuracy?.toFixed(2)}%</div>
              <div className="text-[10px] text-gray-400">œâ={best.config?.lrOmega} Œ±={best.config?.lrAmplitude}</div>
            </div>
            <button onClick={() => onApply(best.config)} className="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 rounded text-xs font-medium">
              Apply Config
            </button>
          </div>
        </div>
      )}
      
      <div className="space-y-1 max-h-48 overflow-y-auto scrollbar-thin">
        {sorted.map((run, i) => (
          <div key={run.id} onClick={() => onSelect(run)} className={`flex items-center justify-between px-2 py-1.5 rounded cursor-pointer hover:bg-slate-700/50 ${i === 0 ? 'bg-yellow-900/20' : i < 3 ? 'bg-slate-700/30' : ''}`}>
            <div className="flex items-center gap-2">
              <span className={`w-5 text-center text-xs font-bold ${i === 0 ? 'text-yellow-400' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-400' : 'text-gray-500'}`}>
                {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`}
              </span>
              <span className="text-sm font-mono text-white">{run.accuracy?.toFixed(2)}%</span>
            </div>
            <div className="text-[10px] text-gray-500">
              œâ={run.config?.lrOmega} Œ±={run.config?.lrAmplitude?.toFixed(2)}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ============================================================
// SMART TUNE ANALYSIS (Claude API)
// ============================================================
const analyzeWithClaude = async (runs, dataset) => {
  const runsData = runs.map((r, i) => ({
    run: i + 1,
    accuracy: r.accuracy?.toFixed(2),
    loss: r.loss?.toFixed(4),
    config: {
      omega: r.config?.lrOmega,
      amplitude: r.config?.lrAmplitude,
      decay: r.config?.lrDecay,
      gf_alpha: r.config?.gfAlpha,
    }
  }));
  
  const prompt = `Analyze these ATF (Adaptive Training Framework) hyperparameter tuning results for ${dataset}:

${JSON.stringify(runsData, null, 2)}

The key parameters are:
- omega (œâ): Angular frequency for periodic LR scheduler (typically 4-8, universal optimum ~6.0)
- amplitude (Œ±): LR oscillation amplitude (0.02-0.16)
- decay (k): Exponential LR decay rate
- gf_alpha: Gradient feedback strength

Please provide:
1. Which parameter has the strongest impact on accuracy?
2. The optimal configuration based on results
3. Recommended next parameters to try
4. Brief explanation of the patterns you see

Format your response as JSON:
{
  "best_config": {"omega": X, "amplitude": X, "decay": X, "gf_alpha": X},
  "key_insight": "one sentence",
  "strongest_parameter": "param_name",
  "recommendation": "one sentence",
  "next_to_try": {"param": "value range to explore"}
}`;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{ role: "user", content: prompt }]
      })
    });
    
    const data = await response.json();
    let text = data.content?.[0]?.text || '';
    
    // Try to extract JSON
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
    return { key_insight: text.slice(0, 200), error: 'Could not parse structured response' };
  } catch (e) {
    return { error: e.message, key_insight: 'Analysis failed - check API connection' };
  }
};

// ============================================================
// AUTOTUNE MODAL
// ============================================================
const AutoTuneModal = ({isOpen, onClose, baseConfig, wsRef, onComplete}) => {
  const [mode, setMode] = useState('quick');
  const [status, setStatus] = useState('idle'); // idle, running, analyzing, complete
  const [currentRun, setCurrentRun] = useState(0);
  const [totalRuns, setTotalRuns] = useState(0);
  const [runs, setRuns] = useState([]);
  const [analysis, setAnalysis] = useState(null);
  const [currentConfig, setCurrentConfig] = useState(null);
  const runningRef = useRef(false);
  const configQueueRef = useRef([]);
  
  const space = SEARCH_SPACES[mode];
  
  const startTune = async () => {
    const configs = generateGridConfigs(baseConfig, space, space.runs);
    configQueueRef.current = configs;
    setTotalRuns(configs.length);
    setCurrentRun(0);
    setRuns([]);
    setAnalysis(null);
    setStatus('running');
    runningRef.current = true;
    
    runNextConfig();
  };
  
  const runNextConfig = () => {
    if (!runningRef.current || configQueueRef.current.length === 0) {
      if (mode === 'smart' && runs.length > 0) {
        runAnalysis();
      } else {
        setStatus('complete');
      }
      return;
    }
    
    const config = configQueueRef.current.shift();
    setCurrentConfig(config);
    setCurrentRun(prev => prev + 1);
    
    // Send config to server
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({command: 'configure', config: {...config, epochs: Math.min(config.epochs, 5)}}));
      wsRef.current.send(JSON.stringify({command: 'start'}));
    }
  };
  
  const runAnalysis = async () => {
    setStatus('analyzing');
    const result = await analyzeWithClaude(runs, baseConfig.dataset);
    setAnalysis(result);
    setStatus('complete');
  };
  
  const handleRunComplete = (accuracy, loss) => {
    setRuns(prev => [...prev, {
      id: Date.now(),
      accuracy,
      loss,
      config: {...currentConfig}
    }]);
    
    setTimeout(() => runNextConfig(), 500);
  };
  
  const stopTune = () => {
    runningRef.current = false;
    configQueueRef.current = [];
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({command: 'stop'}));
    }
    setStatus('complete');
  };
  
  const applyConfig = (config) => {
    onComplete(config);
    onClose();
  };
  
  // Listen for training completion
  useEffect(() => {
    if (!wsRef.current) return;
    
    const originalOnMessage = wsRef.current.onmessage;
    wsRef.current.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      
      if (status === 'running' && msg.type === 'state' && msg.data?.status === 'completed') {
        handleRunComplete(msg.data.best_accuracy, msg.data.val_loss);
      }
      
      // Call original handler
      if (originalOnMessage) originalOnMessage(event);
    };
    
    return () => {
      if (wsRef.current) wsRef.current.onmessage = originalOnMessage;
    };
  }, [status, currentConfig]);
  
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
      <div className="bg-slate-800 rounded-xl border border-slate-600 w-[700px] max-h-[80vh] overflow-hidden">
        {/* Header */}
        <div className="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-gradient-to-r from-purple-900/30 to-blue-900/30">
          <div className="flex items-center gap-2">
            <Icons.Tune />
            <span className="font-bold text-lg">AutoTune</span>
            <span className="text-xs text-gray-400">Hyperparameter Optimization</span>
          </div>
          <button onClick={onClose} className="p-1 hover:bg-slate-700 rounded"><Icons.X /></button>
        </div>
        
        {/* Content */}
        <div className="p-4 overflow-y-auto max-h-[60vh]">
          {status === 'idle' && (
            <>
              {/* Mode Selection */}
              <div className="grid grid-cols-3 gap-3 mb-4">
                {Object.entries(SEARCH_SPACES).map(([key, s]) => (
                  <button key={key} onClick={() => setMode(key)} className={`p-3 rounded-lg border-2 transition-all ${mode === key ? 'border-blue-500 bg-blue-900/20' : 'border-slate-600 hover:border-slate-500'}`}>
                    <div className="flex items-center gap-2 mb-1">
                      {key === 'quick' && <Icons.Zap className="text-yellow-400"/>}
                      {key === 'full' && <Icons.Tune className="text-blue-400"/>}
                      {key === 'smart' && <Icons.Sparkles className="text-purple-400"/>}
                      <span className={`font-bold ${mode === key ? 'text-white' : 'text-gray-300'}`}>{s.name}</span>
                    </div>
                    <div className="text-[10px] text-gray-500">{s.description}</div>
                    <div className="text-xs text-gray-400 mt-1">{s.runs} runs</div>
                  </button>
                ))}
              </div>
              
              {/* Search Space Preview */}
              <div className="bg-slate-900/50 rounded-lg p-3 mb-4">
                <div className="text-xs text-gray-400 mb-2">Parameters to search:</div>
                <div className="flex flex-wrap gap-2">
                  {Object.entries(space.params).map(([key, values]) => (
                    <div key={key} className="px-2 py-1 bg-slate-700 rounded text-[10px]">
                      <span className="text-blue-400">{key}</span>
                      <span className="text-gray-500">: [{values.join(', ')}]</span>
                    </div>
                  ))}
                </div>
              </div>
              
              {mode === 'smart' && (
                <div className="bg-purple-900/20 border border-purple-600/30 rounded-lg p-3 mb-4">
                  <div className="flex items-center gap-2 text-purple-400 text-sm mb-1">
                    <Icons.Sparkles />
                    <span>AI-Powered Analysis</span>
                  </div>
                  <div className="text-[11px] text-gray-400">
                    After runs complete, Claude will analyze results and provide:
                    <ul className="list-disc ml-4 mt-1">
                      <li>Optimal configuration recommendation</li>
                      <li>Key insights about parameter sensitivity</li>
                      <li>Suggestions for further exploration</li>
                    </ul>
                  </div>
                </div>
              )}
            </>
          )}
          
          {status === 'running' && (
            <div className="text-center py-8">
              <Icons.Loader />
              <div className="text-xl font-bold mt-4">Running AutoTune...</div>
              <div className="text-gray-400 mt-2">Run {currentRun} of {totalRuns}</div>
              
              {/* Progress bar */}
              <div className="w-full bg-slate-700 rounded-full h-3 mt-4">
                <div className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all" style={{width: `${(currentRun/totalRuns)*100}%`}}/>
              </div>
              
              {/* Current config */}
              {currentConfig && (
                <div className="mt-4 text-left bg-slate-900/50 rounded p-3">
                  <div className="text-xs text-gray-500 mb-1">Current config:</div>
                  <div className="font-mono text-[11px] text-blue-400">
                    œâ={currentConfig.lrOmega} Œ±={currentConfig.lrAmplitude} k={currentConfig.lrDecay} gf={currentConfig.gfAlpha}
                  </div>
                </div>
              )}
              
              {/* Intermediate results */}
              {runs.length > 0 && (
                <div className="mt-4">
                  <Leaderboard runs={runs} onSelect={() => {}} onApply={applyConfig} />
                </div>
              )}
            </div>
          )}
          
          {status === 'analyzing' && (
            <div className="text-center py-8">
              <Icons.Sparkles className="w-8 h-8 text-purple-400 mx-auto animate-pulse" />
              <div className="text-xl font-bold mt-4 text-purple-400">Claude is analyzing results...</div>
              <div className="text-gray-400 mt-2">Finding optimal configuration</div>
            </div>
          )}
          
          {status === 'complete' && (
            <>
              {/* Results */}
              <Leaderboard runs={runs} onSelect={() => {}} onApply={applyConfig} />
              
              {/* Smart Analysis */}
              {analysis && (
                <div className="mt-4 bg-gradient-to-r from-purple-900/20 to-blue-900/20 border border-purple-600/30 rounded-lg p-4">
                  <div className="flex items-center gap-2 text-purple-400 font-bold mb-3">
                    <Icons.Sparkles />
                    <span>Claude's Analysis</span>
                  </div>
                  
                  {analysis.error ? (
                    <div className="text-red-400 text-sm">{analysis.error}</div>
                  ) : (
                    <>
                      <div className="space-y-3">
                        {analysis.key_insight && (
                          <div>
                            <div className="text-[10px] text-gray-500 uppercase">Key Insight</div>
                            <div className="text-sm text-white">{analysis.key_insight}</div>
                          </div>
                        )}
                        
                        {analysis.strongest_parameter && (
                          <div>
                            <div className="text-[10px] text-gray-500 uppercase">Most Important Parameter</div>
                            <div className="text-sm text-yellow-400 font-mono">{analysis.strongest_parameter}</div>
                          </div>
                        )}
                        
                        {analysis.best_config && (
                          <div>
                            <div className="text-[10px] text-gray-500 uppercase">Recommended Config</div>
                            <div className="font-mono text-xs text-green-400 bg-slate-900/50 rounded p-2">
                              œâ={analysis.best_config.omega} Œ±={analysis.best_config.amplitude} k={analysis.best_config.decay} gf={analysis.best_config.gf_alpha}
                            </div>
                            <button onClick={() => applyConfig({
                              ...baseConfig,
                              lrOmega: analysis.best_config.omega,
                              lrAmplitude: analysis.best_config.amplitude,
                              lrDecay: analysis.best_config.decay,
                              gfAlpha: analysis.best_config.gf_alpha,
                            })} className="mt-2 px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-xs">
                              Apply Claude's Recommendation
                            </button>
                          </div>
                        )}
                        
                        {analysis.recommendation && (
                          <div>
                            <div className="text-[10px] text-gray-500 uppercase">Next Steps</div>
                            <div className="text-sm text-gray-300">{analysis.recommendation}</div>
                          </div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              )}
            </>
          )}
        </div>
        
        {/* Footer */}
        <div className="px-4 py-3 border-t border-slate-700 flex justify-between">
          <button onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
            Close
          </button>
          
          {status === 'idle' && (
            <button onClick={startTune} className="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded text-sm font-medium flex items-center gap-2">
              <Icons.Play />
              Start {space.name}
            </button>
          )}
          
          {status === 'running' && (
            <button onClick={stopTune} className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-medium flex items-center gap-2">
              <Icons.Stop />
              Stop
            </button>
          )}
          
          {status === 'complete' && mode !== 'smart' && runs.length >= 3 && (
            <button onClick={runAnalysis} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded text-sm font-medium flex items-center gap-2">
              <Icons.Sparkles />
              Analyze with Claude
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// ============================================================
// MAIN DASHBOARD COMPONENT
// ============================================================
const Dashboard = () => {
  const [connected, setConnected] = useState(false);
  const [connecting, setConnecting] = useState(false);
  const [serverUrl, setServerUrl] = useState('ws://localhost:8000/ws');
  const [config, setConfig] = useState({...DEFAULT_CONFIG});
  const [state, setState] = useState({status: 'idle', epoch: 0, total_epochs: 10, batch: 0, train_loss: 0, val_loss: 0, accuracy: 0, best_accuracy: 0, best_epoch: 0, learning_rate: 0.001, beta: 0.0, omega: 6.0, r2: 0, confidence: 1.0, stillness: false, curvature: 0, lr_reduced: false, checkpoint: false, early_stopped: false, perplexity: 0});
  const [metrics, setMetrics] = useState({loss: [], accuracy: [], lr: [], beta: [], val_loss: [], perplexity: []});
  const [logs, setLogs] = useState([]);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [epochTimes, setEpochTimes] = useState([]);
  const [showAutoTune, setShowAutoTune] = useState(false);
  
  const wsRef = useRef(null);
  const timerRef = useRef(null);
  const epochStartRef = useRef(null);
  const lastEpochRef = useRef(0);

  const addLog = (msg, level = 'info') => setLogs(p => [...p.slice(-200), {time: new Date().toLocaleTimeString(), message: msg, level}]);
  const updateConfig = (k, v) => {
    setConfig(p => {
      const n = {...p, [k]: v};
      if (wsRef.current?.readyState === WebSocket.OPEN) {
        wsRef.current.send(JSON.stringify({command: 'configure', config: n}));
      }
      return n;
    });
  };

  const connect = () => {
    setConnecting(true);
    const ws = new WebSocket(serverUrl);
    ws.onopen = () => { setConnected(true); setConnecting(false); addLog('Connected', 'success'); ws.send(JSON.stringify({command: 'configure', config})); };
    ws.onclose = () => { setConnected(false); addLog('Disconnected', 'warning'); };
    ws.onerror = () => { setConnecting(false); addLog('Connection error', 'error'); };
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      if (msg.type === 'state') {
        const d = msg.data;
        setState(p => ({...p, ...d}));
        
        if (d.epoch !== lastEpochRef.current) {
          if (epochStartRef.current && d.epoch > 0) {
            const dur = (Date.now() - epochStartRef.current) / 1000;
            setEpochTimes(p => [...p, dur].slice(-20));
          }
          epochStartRef.current = Date.now();
          lastEpochRef.current = d.epoch;
        }
        
        if (d.train_loss) setMetrics(p => ({...p, loss: [...p.loss.slice(-299), {e: d.epoch, v: d.train_loss}]}));
        if (d.accuracy) setMetrics(p => ({...p, accuracy: [...p.accuracy.slice(-299), {e: d.epoch, v: d.accuracy}]}));
        if (d.learning_rate) setMetrics(p => ({...p, lr: [...p.lr.slice(-299), {e: d.epoch, v: d.learning_rate * 1000}]}));
        if (d.beta !== undefined) setMetrics(p => ({...p, beta: [...p.beta.slice(-299), {e: d.epoch, v: d.beta}]}));
        if (d.val_loss) setMetrics(p => ({...p, val_loss: [...p.val_loss.slice(-299), {e: d.epoch, v: d.val_loss}]}));
        if (d.perplexity) setMetrics(p => ({...p, perplexity: [...p.perplexity.slice(-299), {e: d.epoch, v: d.perplexity}]}));
        
        if (d.status === 'running' && !timerRef.current) {
          timerRef.current = setInterval(() => setElapsedTime(p => p + 1), 1000);
        } else if (d.status !== 'running' && timerRef.current) {
          clearInterval(timerRef.current);
          timerRef.current = null;
        }
      } else if (msg.type === 'log') {
        addLog(msg.data.message, msg.data.level || 'info');
      }
    };
    wsRef.current = ws;
  };

  const disconnect = () => { wsRef.current?.close(); wsRef.current = null; };
  const sendCommand = (cmd) => wsRef.current?.send(JSON.stringify({command: cmd}));
  const startTraining = () => { setElapsedTime(0); setEpochTimes([]); epochStartRef.current = Date.now(); lastEpochRef.current = 0; setMetrics({loss: [], accuracy: [], lr: [], beta: [], val_loss: [], perplexity: []}); sendCommand('start'); };

  useEffect(() => () => { if (wsRef.current) wsRef.current.close(); clearInterval(timerRef.current); }, []);
  
  const isRunning = state.status === 'running';
  const currentDataset = ALL_DATASETS.find(d => d.value === config.dataset) || ALL_DATASETS[0];
  const isPerplexityMetric = currentDataset.metric === 'perplexity';
  const avgEpochTime = epochTimes.length > 0 ? epochTimes.reduce((a,b) => a+b, 0) / epochTimes.length : 0;
  const statusColors = {idle: 'bg-gray-600', running: 'bg-green-500 animate-pulse', paused: 'bg-yellow-500', completed: 'bg-blue-500', error: 'bg-red-500'};

  const applyAutoTuneConfig = (newConfig) => {
    setConfig(p => ({...p, ...newConfig}));
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({command: 'configure', config: {...config, ...newConfig}}));
    }
    addLog('AutoTune config applied!', 'success');
  };

  return (
    <div className="min-h-screen bg-slate-900 text-white text-sm">
      {/* Header */}
      <header className="bg-slate-800 border-b border-slate-700 px-3 py-1.5 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"><Icons.Brain/></div>
          <div><h1 className="font-bold text-sm">ATF Dashboard <span className="text-[9px] bg-purple-600 px-1 py-0.5 rounded ml-1">AUTOTUNE</span></h1></div>
        </div>
        <div className="flex items-center gap-4 bg-slate-700/50 px-3 py-1 rounded-lg">
          <div className="flex items-center gap-1.5"><Icons.Clock/><div><div className="text-[9px] text-gray-400">ELAPSED</div><div className="font-mono font-bold text-green-400">{formatTime(elapsedTime)}</div></div></div>
          {avgEpochTime > 0 && state.status === 'running' && <div><div className="text-[9px] text-gray-400">ETA</div><div className="font-mono text-yellow-400">{formatTime(avgEpochTime * (config.epochs - state.epoch))}</div></div>}
        </div>
        <div className="flex items-center gap-2">
          {connected ? <span className="text-green-400"><Icons.Wifi/></span> : <span className="text-gray-500"><Icons.WifiOff/></span>}
          <span className={`px-2 py-0.5 rounded-full text-[9px] font-bold ${statusColors[state.status]||'bg-gray-600'}`}>{state.status?.toUpperCase()}</span>
        </div>
      </header>

      <div className="flex" style={{height: 'calc(100vh - 44px)'}}>
        {/* Sidebar */}
        <aside className="w-72 bg-slate-800/50 border-r border-slate-700 overflow-y-auto scrollbar-thin p-1.5">
          {/* Connection */}
          <Section title="üîå Connection" color="green" defaultOpen={!connected}>
            <input type="text" value={serverUrl} onChange={e => setServerUrl(e.target.value)} className="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-xs mb-1.5" disabled={connected}/>
            {!connected ? <button onClick={connect} disabled={connecting} className="w-full px-2 py-1 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 rounded text-xs font-medium">{connecting ? 'Connecting...' : 'Connect'}</button>
             : <button onClick={disconnect} className="w-full px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs font-medium">Disconnect</button>}
          </Section>

          {/* Dataset */}
          <Section title="üìä Dataset" color="blue">
            <Select label="Dataset" value={config.dataset} onChange={v => { updateConfig('dataset', v); const ds = ALL_DATASETS.find(d => d.value === v); if (ds) updateConfig('epochs', ds.epochs); }} options={ALL_DATASETS.map(d => ({value: d.value, label: d.label}))} disabled={isRunning}/>
            <Slider label="Epochs" value={config.epochs} onChange={v => updateConfig('epochs', v)} min={1} max={100} step={1} disabled={isRunning}/>
            <Slider label="Batch Size" value={config.batchSize} onChange={v => updateConfig('batchSize', v)} min={8} max={256} step={8} disabled={isRunning}/>
            <Slider label="Learning Rate" value={config.learningRate} onChange={v => updateConfig('learningRate', v)} min={0.00001} max={0.01} step={0.00001} disabled={isRunning}/>
            <Toggle label="Real Training" enabled={config.useRealTraining} onChange={v => updateConfig('useRealTraining', v)} disabled={isRunning} desc="Use PyTorch"/>
          </Section>

          {/* AutoTune */}
          <Section title="üîß AutoTune" color="purple">
            <div className="text-[10px] text-gray-400 mb-2">
              Automatically search for optimal hyperparameters
            </div>
            <button onClick={() => setShowAutoTune(true)} disabled={!connected || isRunning} className="w-full px-3 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-600 rounded text-xs font-medium flex items-center justify-center gap-2">
              <Icons.Tune />
              Open AutoTune
            </button>
            <div className="mt-2 grid grid-cols-3 gap-1 text-[9px]">
              <div className="text-center p-1 bg-yellow-900/20 rounded border border-yellow-700/30">
                <div className="text-yellow-400 font-bold">Quick</div>
                <div className="text-gray-500">5 runs</div>
              </div>
              <div className="text-center p-1 bg-blue-900/20 rounded border border-blue-700/30">
                <div className="text-blue-400 font-bold">Full</div>
                <div className="text-gray-500">15 runs</div>
              </div>
              <div className="text-center p-1 bg-purple-900/20 rounded border border-purple-700/30">
                <div className="text-purple-400 font-bold">Smart</div>
                <div className="text-gray-500">AI-guided</div>
              </div>
            </div>
          </Section>

          {/* Key Parameters */}
          <Section title="‚ö° Key Parameters" color="yellow">
            <Slider label="œâ (Omega)" value={config.lrOmega} onChange={v => updateConfig('lrOmega', v)} min={1} max={12} step={0.1} disabled={isRunning}/>
            <Slider label="Œ± (Amplitude)" value={config.lrAmplitude} onChange={v => updateConfig('lrAmplitude', v)} min={0} max={0.2} step={0.01} disabled={isRunning}/>
            <Slider label="k (Decay)" value={config.lrDecay} onChange={v => updateConfig('lrDecay', v)} min={0} max={0.01} step={0.001} disabled={isRunning}/>
            <Slider label="GF Alpha" value={config.gfAlpha} onChange={v => updateConfig('gfAlpha', v)} min={0} max={0.2} step={0.01} disabled={isRunning}/>
            <Slider label="Patience" value={config.caPatience} onChange={v => updateConfig('caPatience', v)} min={1} max={20} step={1} disabled={isRunning}/>
            <Toggle label="Early Stopping" enabled={config.useEarlyStopping} onChange={v => updateConfig('useEarlyStopping', v)} disabled={isRunning}/>
          </Section>
        </aside>

        {/* Main */}
        <main className="flex-1 p-3 overflow-y-auto">
          {/* Controls */}
          <div className="flex items-center gap-2 mb-3 bg-slate-800/50 p-2 rounded-lg">
            <button onClick={startTraining} disabled={!connected || isRunning} className="px-3 py-1.5 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 rounded text-xs font-medium flex items-center gap-1"><Icons.Play/>Start</button>
            <button onClick={() => sendCommand('pause')} disabled={!connected || state.status !== 'running'} className="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 disabled:bg-gray-600 rounded text-xs font-medium flex items-center gap-1"><Icons.Pause/>Pause</button>
            <button onClick={() => sendCommand('stop')} disabled={!connected || state.status === 'idle'} className="px-3 py-1.5 bg-red-600 hover:bg-red-500 disabled:bg-gray-600 rounded text-xs font-medium flex items-center gap-1"><Icons.Stop/>Stop</button>
            <div className="flex-1 text-center">
              <span className="text-gray-400">Epoch</span>
              <span className="font-mono font-bold text-blue-400 ml-2">{state.epoch}/{config.epochs}</span>
              <span className="text-gray-500 ml-4 text-xs">{currentDataset.label}</span>
            </div>
          </div>

          {/* Metrics Grid */}
          <div className="grid grid-cols-6 gap-2 mb-3">
            {isPerplexityMetric ? (
              <MetricBox label="Perplexity" value={state.perplexity?.toFixed(2)||'‚Äî'} unit="" color="purple"/>
            ) : (
              <MetricBox label="Best Acc" value={state.best_accuracy?.toFixed(2)||'‚Äî'} unit="%" color="green"/>
            )}
            <MetricBox label="Curr Acc" value={state.accuracy?.toFixed(2)||'‚Äî'} unit="%" color="cyan"/>
            <MetricBox label="Train Loss" value={state.train_loss?.toFixed(4)||'‚Äî'} unit="" color="blue"/>
            <MetricBox label="Val Loss" value={state.val_loss?.toFixed(4)||'‚Äî'} unit="" color="purple"/>
            <MetricBox label="LR" value={(state.learning_rate*1000)?.toFixed(3)||'‚Äî'} unit="√ó10‚Åª¬≥" color="yellow"/>
            <MetricBox label="Best @ Ep" value={state.best_epoch||'‚Äî'} unit="" color="gray"/>
          </div>

          {/* ATF Metrics */}
          <div className="grid grid-cols-6 gap-2 mb-3">
            <MetricBox label="Œ≤" value={state.beta?.toFixed(4)||'‚Äî'} unit="" color="orange" small/>
            <MetricBox label="œâ" value={state.omega?.toFixed(1)||'6.0'} unit="" color="purple" small/>
            <MetricBox label="R¬≤" value={state.r2?.toFixed(3)||'‚Äî'} unit="" color="blue" small/>
            <MetricBox label="Conf" value={state.confidence?.toFixed(2)||'‚Äî'} unit="" color="cyan" small/>
            <MetricBox label="Curv" value={state.curvature?.toExponential(1)||'‚Äî'} unit="" color="pink" small/>
            <div className="bg-gray-800/60 border-l-2 border-gray-500 rounded px-2 py-1">
              <div className="text-[9px] text-gray-500">FLAGS</div>
              <div className="flex gap-1 text-[10px]">
                <span className={state.stillness ? 'text-yellow-400' : 'text-gray-600'}>STILL</span>
                <span className={state.lr_reduced ? 'text-red-400' : 'text-gray-600'}>LR‚Üì</span>
                <span className={state.checkpoint ? 'text-green-400' : 'text-gray-600'}>CKPT</span>
                <span className={state.early_stopped ? 'text-red-500 font-bold animate-pulse' : 'text-gray-600'}>STOP</span>
              </div>
            </div>
          </div>

          {/* Charts */}
          <div className="grid grid-cols-3 gap-2 mb-3">
            <Chart data={metrics.loss} dataKey="v" color="#3b82f6" title="üìâ Train Loss"/>
            {isPerplexityMetric ? (
              <Chart data={metrics.perplexity} dataKey="v" color="#a855f7" title="üìä Perplexity"/>
            ) : (
              <Chart data={metrics.accuracy} dataKey="v" color="#10b981" title="üìà Accuracy"/>
            )}
            <Chart data={metrics.beta} dataKey="v" color="#f97316" title="üéØ Œ≤ Convergence"/>
          </div>

          <div className="grid grid-cols-3 gap-2 mb-3">
            <Chart data={metrics.lr} dataKey="v" color="#eab308" title="‚ö° Learning Rate (√ó10‚Åª¬≥)"/>
            <Chart data={metrics.val_loss} dataKey="v" color="#8b5cf6" title="üìä Val Loss"/>
            <div className="bg-gray-800/40 rounded p-2">
              <div className="text-[10px] text-gray-500 mb-1">Current Config</div>
              <div className="font-mono text-[10px] text-blue-400">
                œâ={config.lrOmega} Œ±={config.lrAmplitude} k={config.lrDecay}
              </div>
              <div className="font-mono text-[10px] text-green-400">
                gf={config.gfAlpha} patience={config.caPatience}
              </div>
            </div>
          </div>

          {/* Log */}
          <div className="bg-slate-800/30 rounded-lg border border-slate-700 p-2">
            <div className="text-[10px] text-gray-500 mb-1">Log</div>
            <div className="h-32 overflow-y-auto scrollbar-thin font-mono text-[10px]">
              {logs.slice(-50).map((l, i) => (
                <div key={i} className={`${l.level === 'error' ? 'text-red-400' : l.level === 'success' ? 'text-green-400' : l.level === 'warning' ? 'text-yellow-400' : 'text-gray-400'}`}>
                  <span className="text-gray-600">[{l.time}]</span> {l.message}
                </div>
              ))}
            </div>
          </div>
        </main>
      </div>

      {/* AutoTune Modal */}
      <AutoTuneModal 
        isOpen={showAutoTune} 
        onClose={() => setShowAutoTune(false)} 
        baseConfig={config}
        wsRef={wsRef}
        onComplete={applyAutoTuneConfig}
      />
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
    </script>
</body>
</html>
